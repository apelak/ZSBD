##ZADANIE 1

CREATE OR REPLACE PROCEDURE add_job (
    p_job_id    IN jobs.job_id%TYPE,
    p_job_title IN jobs.job_title%TYPE
) IS
BEGIN
    INSERT INTO jobs (job_id, job_title) 
    VALUES (p_job_id, p_job_title);
    
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('Dodano stanowisko: ' || p_job_title);
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Błąd (Kod: ' || SQLCODE || '): ' || SQLERRM);
END;

BEGIN
    add_job('TEST_JOB', 'Test Developer');
    add_job('TEST_JOB', 'Test Developer');
END;

Dodano stanowisko: Test Developer
Błąd (Kod: -1): ORA-00001: unique constraint (PELAKA.JOB_ID_PK) violated

##ZADANIE 2

CREATE OR REPLACE PROCEDURE update_job_title (
    p_job_id    IN jobs.job_id%TYPE,
    p_new_title IN jobs.job_title%TYPE
) IS
    e_no_jobs_updated EXCEPTION;
BEGIN
    UPDATE jobs 
    SET job_title = p_new_title 
    WHERE job_id = p_job_id;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE e_no_jobs_updated;
    END IF;

    COMMIT;
    DBMS_OUTPUT.PUT_LINE('Zaktualizowano stanowisko ID: ' || p_job_id);
EXCEPTION
    WHEN e_no_jobs_updated THEN
        DBMS_OUTPUT.PUT_LINE('Błąd: Nie znaleziono stanowiska o ID: ' || p_job_id);
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Inny błąd: ' || SQLERRM);
END;

BEGIN
    update_job_title('TEST_JOB', 'Senior Test Developer');
    update_job_title('GHOST_JOB', 'Ghost Hunter');
END;

Zaktualizowano stanowisko ID: TEST_JOB
Błąd: Nie znaleziono stanowiska o ID: GHOST_JOB

##ZADANIE 3

CREATE OR REPLACE PROCEDURE delete_job (
    p_job_id IN jobs.job_id%TYPE
) IS
    e_no_jobs_deleted EXCEPTION;
BEGIN
    DELETE FROM jobs 
    WHERE job_id = p_job_id;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE e_no_jobs_deleted;
    END IF;

    COMMIT;
    DBMS_OUTPUT.PUT_LINE('Usunięto stanowisko ID: ' || p_job_id);
EXCEPTION
    WHEN e_no_jobs_deleted THEN
        DBMS_OUTPUT.PUT_LINE('Wyjątek: Nie usunięto żadnego wiersza (brak ID: ' || p_job_id || ')');
    WHEN OTHERS THEN
        
        DBMS_OUTPUT.PUT_LINE('Błąd usuwania: ' || SQLERRM);
END;

BEGIN
    delete_job('TEST_JOB');
    delete_job('NIEISTNIEJE');
END;

Usunięto stanowisko ID: TEST_JOB
Wyjątek: Nie usunięto żadnego wiersza (brak ID: NIEISTNIEJE)

##ZADANIE 4

CREATE OR REPLACE PROCEDURE get_emp_salary (
    p_emp_id   IN employees.employee_id%TYPE,
    p_salary   OUT employees.salary%TYPE,
    p_lastname OUT employees.last_name%TYPE
) IS
BEGIN
    SELECT salary, last_name 
    INTO p_salary, p_lastname 
    FROM employees 
    WHERE employee_id = p_emp_id;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        p_salary := 0;
        p_lastname := 'Nieznany';
        DBMS_OUTPUT.PUT_LINE('Nie znaleziono pracownika o ID: ' || p_emp_id);
END;

DECLARE
    v_sal NUMBER;
    v_name VARCHAR2(50);
BEGIN
    get_emp_salary(100, v_sal, v_name);
    DBMS_OUTPUT.PUT_LINE('Pracownik: ' || v_name || ', Zarobki: ' || v_sal);
END;

Pracownik: King, Zarobki: 24000

##ZADANIE 5

CREATE OR REPLACE PROCEDURE add_employee_custom (
    p_lastname IN employees.last_name%TYPE,
    p_email    IN employees.email%TYPE,
    p_job_id   IN employees.job_id%TYPE,
    p_salary   IN employees.salary%TYPE
) IS
    e_salary_too_high EXCEPTION;
    v_new_id employees.employee_id%TYPE;
BEGIN
    IF p_salary > 20000 THEN
        RAISE e_salary_too_high;
    END IF;

    SELECT NVL(MAX(employee_id), 0) + 1 
    INTO v_new_id 
    FROM employees;

    INSERT INTO employees (employee_id, last_name, email, hire_date, job_id, salary)
    VALUES (
        v_new_id,   
        p_lastname, 
        p_email, 
        SYSDATE, 
        p_job_id, 
        p_salary
    );
    
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('Dodano pracownika: ' || p_lastname || ' z ID: ' || v_new_id);

EXCEPTION
    WHEN e_salary_too_high THEN
        DBMS_OUTPUT.PUT_LINE('Błąd: Wynagrodzenie ' || p_salary || ' przekracza limit 20000!');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Błąd SQL: ' || SQLERRM);
END;

BEGIN
    add_employee_custom('Nowak', 'NOWAK1', 'IT_PROG', 25000);
    add_employee_custom('Kowalski', 'KOWAL1', 'IT_PROG', 5000);
END;

Błąd: Wynagrodzenie 25000 przekracza limit 20000!
Dodano pracownika: Kowalski z ID: 207

##ZADANIE 6

CREATE OR REPLACE PROCEDURE get_manager_avg_salary (
    p_manager_id IN employees.manager_id%TYPE,
    p_avg_salary OUT NUMBER
) IS
BEGIN
    SELECT AVG(salary)
    INTO p_avg_salary
    FROM employees
    WHERE manager_id = p_manager_id;

    IF p_avg_salary IS NULL THEN
        p_avg_salary := 0;
        DBMS_OUTPUT.PUT_LINE('Manager ID ' || p_manager_id || ' nie ma podwładnych.');
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Błąd: ' || SQLERRM);
END;

DECLARE
    v_avg NUMBER;
BEGIN
    get_manager_avg_salary(100, v_avg); 
    DBMS_OUTPUT.PUT_LINE('Średnia zarobków podwładnych: ' || ROUND(v_avg, 2));
END;

Średnia zarobków podwładnych: 11100

##ZADANIE 7

CREATE OR REPLACE PROCEDURE raise_salary_dept (
    p_dept_id IN departments.department_id%TYPE,
    p_percent IN NUMBER
) IS
    v_min_sal jobs.min_salary%TYPE;
    v_max_sal jobs.max_salary%TYPE;
    v_new_sal employees.salary%TYPE;
    v_dept_check NUMBER;
    e_dept_not_found EXCEPTION;
    PRAGMA EXCEPTION_INIT(e_dept_not_found, -20001);
BEGIN
    SELECT COUNT(*) INTO v_dept_check FROM departments WHERE department_id = p_dept_id;
    IF v_dept_check = 0 THEN
        RAISE_APPLICATION_ERROR(-20291, 'Nieistniejący Department ID (Symulacja ORA-02291)');
    END IF;

    FOR r IN (SELECT employee_id, salary, job_id, last_name FROM employees WHERE department_id = p_dept_id) 
    LOOP
        SELECT min_salary, max_salary INTO v_min_sal, v_max_sal 
        FROM jobs WHERE job_id = r.job_id;

        v_new_sal := r.salary * (1 + p_percent/100);

        IF v_new_sal BETWEEN v_min_sal AND v_max_sal THEN
            UPDATE employees SET salary = v_new_sal WHERE employee_id = r.employee_id;
            DBMS_OUTPUT.PUT_LINE('Zaktualizowano: ' || r.last_name || ' na ' || v_new_sal);
        ELSE
            DBMS_OUTPUT.PUT_LINE('Pominięto: ' || r.last_name || ' (Nowa pensja ' || v_new_sal || ' poza zakresem)');
        END IF;
    END LOOP;
    
    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Błąd procedury: ' || SQLERRM);
END;

BEGIN
    raise_salary_dept(60, 10);
    raise_salary_dept(9999, 10);
END;

Zaktualizowano: Hunold na 9900
Zaktualizowano: Ernst na 6600
Zaktualizowano: Austin na 5280
Zaktualizowano: Pataballa na 5280
Zaktualizowano: Lorentz na 4620
Błąd procedury: ORA-20291: Nieistniejący Department ID (Symulacja ORA-02291)

##ZADANIE 8

CREATE OR REPLACE PROCEDURE transfer_employee (
    p_emp_id     IN employees.employee_id%TYPE,
    p_new_dept_id IN departments.department_id%TYPE
) IS
    v_dept_exists NUMBER;
    e_emp_not_found EXCEPTION;
    e_dept_not_found EXCEPTION;
BEGIN
    SELECT COUNT(*) INTO v_dept_exists FROM departments WHERE department_id = p_new_dept_id;
    
    IF v_dept_exists = 0 THEN
        RAISE e_dept_not_found;
    END IF;

    UPDATE employees 
    SET department_id = p_new_dept_id 
    WHERE employee_id = p_emp_id;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE e_emp_not_found;
    END IF;

    COMMIT;
    DBMS_OUTPUT.PUT_LINE('Przeniesiono pracownika ' || p_emp_id || ' do departamentu ' || p_new_dept_id);

EXCEPTION
    WHEN e_dept_not_found THEN
        DBMS_OUTPUT.PUT_LINE('Błąd: Departament docelowy ID ' || p_new_dept_id || ' nie istnieje.');
    WHEN e_emp_not_found THEN
        DBMS_OUTPUT.PUT_LINE('Błąd własny: Pracownik o ID ' || p_emp_id || ' nie istnieje.');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Inny błąd: ' || SQLERRM);
END;

BEGIN
    transfer_employee(103, 60);
    transfer_employee(9999, 60);
END;

Przeniesiono pracownika 103 do departamentu 60
Błąd własny: Pracownik o ID 9999 nie istnieje.

##ZADANIE 9

CREATE OR REPLACE PROCEDURE delete_dept_if_empty (
    p_dept_id IN departments.department_id%TYPE
) IS
    v_count NUMBER;
    e_has_employees EXCEPTION;
BEGIN
    SELECT COUNT(*) INTO v_count 
    FROM employees 
    WHERE department_id = p_dept_id;

    IF v_count > 0 THEN
        RAISE_APPLICATION_ERROR(-20005, 'Departament posiada przypisanych pracowników!');
    END IF;

    DELETE FROM departments 
    WHERE department_id = p_dept_id;

    IF SQL%ROWCOUNT = 0 THEN
        DBMS_OUTPUT.PUT_LINE('Nie znaleziono departamentu o ID: ' || p_dept_id);
    ELSE
        COMMIT;
        DBMS_OUTPUT.PUT_LINE('Departament ' || p_dept_id || ' został usunięty.');
    END IF;

EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Wystąpił błąd podczas usuwania departamentu!');
        DBMS_OUTPUT.PUT_LINE('Kod błędu: ' || SQLCODE);
        DBMS_OUTPUT.PUT_LINE('Komunikat: ' || SQLERRM);
        ROLLBACK; 

sprawdzenie: 

BEGIN
    delete_dept_if_empty(60);
    delete_dept_if_empty(400);
END;

Wystąpił błąd podczas usuwania departamentu!
Kod błędu: -20005
Komunikat: ORA-20005: Departament posiada przypisanych pracowników!
Departament 400 został usunięty.


















