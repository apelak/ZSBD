##ZADANIE 1

CREATE OR REPLACE FUNCTION get_job_name(p_job_id jobs.job_id%TYPE)
RETURN VARCHAR2
IS
    v_job_title jobs.job_title%TYPE;
BEGIN
    SELECT job_title INTO v_job_title
    FROM jobs
    WHERE job_id = p_job_id;

    RETURN v_job_title;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20001, 'Praca o podanym ID nie istnieje.');
END;

##ZADANIE 2

CREATE OR REPLACE FUNCTION get_yearly_income(p_emp_id employees.employee_id%TYPE)
RETURN NUMBER
IS
    v_salary employees.salary%TYPE;
    v_comm   employees.commission_pct%TYPE;
BEGIN
    SELECT salary, NVL(commission_pct, 0)
    INTO v_salary, v_comm
    FROM employees
    WHERE employee_id = p_emp_id;

    RETURN (v_salary * 12) + (v_salary * v_comm);

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20002, 'Pracownik o podanym ID nie istnieje.');
END;

##ZADANIE 3

CREATE OR REPLACE FUNCTION format_phone(p_phone VARCHAR2)
RETURN VARCHAR2
IS
    v_country VARCHAR2(10);
    v_rest    VARCHAR2(50);
BEGIN
    v_country := SUBSTR(p_phone, 1, INSTR(p_phone, ' ') - 1);
    v_rest    := SUBSTR(p_phone, INSTR(p_phone, ' ') + 1);

    RETURN '(' || v_country || ') ' || v_rest;
END;

##ZADANIE 4

CREATE OR REPLACE FUNCTION capitalize_ends(p_text VARCHAR2)
RETURN VARCHAR2
IS
    v_result VARCHAR2(4000);
BEGIN
    IF LENGTH(p_text) < 1 THEN
        RETURN p_text;
    ELSIF LENGTH(p_text) = 1 THEN
        RETURN UPPER(p_text);
    END IF;

    v_result :=
        UPPER(SUBSTR(p_text, 1, 1)) ||
        LOWER(SUBSTR(p_text, 2, LENGTH(p_text) - 2)) ||
        UPPER(SUBSTR(p_text, -1));

    RETURN v_result;
END;

##ZADANIE 5

CREATE OR REPLACE FUNCTION pesel_to_date(p_pesel VARCHAR2)
RETURN DATE
IS
    v_year  NUMBER;
    v_month NUMBER;
    v_day   NUMBER;
BEGIN
    v_year  := SUBSTR(p_pesel, 1, 2);
    v_month := SUBSTR(p_pesel, 3, 2);
    v_day   := SUBSTR(p_pesel, 5, 2);

    IF v_month > 80 THEN
        v_year := 1800 + v_year;
        v_month := v_month - 80;
    ELSIF v_month > 60 THEN
        v_year := 2200 + v_year;
        v_month := v_month - 60;
    ELSIF v_month > 40 THEN
        v_year := 2100 + v_year;
        v_month := v_month - 40;
    ELSIF v_month > 20 THEN
        v_year := 2000 + v_year;
        v_month := v_month - 20;
    ELSE
        v_year := 1900 + v_year;
    END IF;

    RETURN TO_DATE(v_year || '-' || v_month || '-' || v_day, 'YYYY-MM-DD');
END;

##ZADANIE 6

CREATE OR REPLACE FUNCTION get_country_stats(p_country_name countries.country_name%TYPE)
RETURN VARCHAR2
IS
    v_country_id countries.country_id%TYPE;
    v_dep_count NUMBER;
    v_emp_count NUMBER;
BEGIN
    SELECT country_id INTO v_country_id
    FROM countries
    WHERE LOWER(country_name) = LOWER(p_country_name);

    SELECT COUNT(*)
    INTO v_dep_count
    FROM departments d
    JOIN locations l ON d.location_id = l.location_id
    WHERE l.country_id = v_country_id;

    SELECT COUNT(*)
    INTO v_emp_count
    FROM employees e
    JOIN departments d ON e.department_id = d.department_id
    JOIN locations l ON d.location_id = l.location_id
    WHERE l.country_id = v_country_id;

    RETURN 'Pracownicy: ' || v_emp_count || ', Departamenty: ' || v_dep_count;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20003, 'Kraj o podanej nazwie nie istnieje.');
END;

##ZADANIE 7

CREATE OR REPLACE FUNCTION gen_access_id(
    p_first_name VARCHAR2,
    p_last_name  VARCHAR2,
    p_phone      VARCHAR2
)
RETURN VARCHAR2
IS
    v_last4 VARCHAR2(4);
BEGIN
    v_last4 := SUBSTR(REGEXP_REPLACE(p_phone, '[^0-9]', ''), -4);

    RETURN UPPER(SUBSTR(p_last_name, 1, 3)) ||
           v_last4 ||
           UPPER(SUBSTR(p_first_name, 1, 1));
END;
