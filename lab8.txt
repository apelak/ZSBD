##ZADANIE 1

CREATE TABLE archiwum_departamentow (
    id NUMBER,
    nazwa VARCHAR2(100),
    data_zamkniecia DATE,
    ostatni_manager VARCHAR2(100)
);

CREATE OR REPLACE TRIGGER trg_archive_dept
AFTER DELETE ON departments
FOR EACH ROW
DECLARE
    v_manager_name VARCHAR2(100);
BEGIN
    BEGIN
        IF :OLD.manager_id IS NOT NULL THEN
            SELECT first_name || ' ' || last_name
            INTO v_manager_name
            FROM employees
            WHERE employee_id = :OLD.manager_id;
        ELSE
            v_manager_name := 'Brak Managera';
        END IF;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            v_manager_name := 'Nieznany Manager';
    END;

    INSERT INTO archiwum_departamentow (id, nazwa, data_zamkniecia, ostatni_manager)
    VALUES (:OLD.department_id, :OLD.department_name, SYSDATE, v_manager_name);
END;

##ZADANIE 2

CREATE TABLE zlodziej (
    id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    db_user VARCHAR2(50),
    czas_zmiany DATE
);

CREATE OR REPLACE TRIGGER trg_check_salary
BEFORE INSERT OR UPDATE OF salary ON employees
FOR EACH ROW
DECLARE
    PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
    IF :NEW.salary NOT BETWEEN 2000 AND 26000 THEN
        INSERT INTO zlodziej (db_user, czas_zmiany)
        VALUES (USER, SYSDATE);
        
        COMMIT;

        RAISE_APPLICATION_ERROR(-20001, 'Błąd: Wynagrodzenie musi mieścić się w przedziale 2000 - 26000.');
    END IF;
END;

##ZADANIE 3

CREATE SEQUENCE employees_seq
START WITH 300 
INCREMENT BY 1;

CREATE OR REPLACE TRIGGER trg_employees_id
BEFORE INSERT ON employees
FOR EACH ROW
BEGIN
    IF :NEW.employee_id IS NULL THEN
        SELECT employees_seq.NEXTVAL INTO :NEW.employee_id FROM dual;
    END IF;
END;

##ZADANIE 4

CREATE OR REPLACE TRIGGER trg_lock_job_grades
BEFORE INSERT OR UPDATE OR DELETE ON job_grades
BEGIN
    RAISE_APPLICATION_ERROR(-20002, 'Operacje na tabeli JOB_GRADES są zabronione.');
END;

##ZADANIE 5

CREATE OR REPLACE TRIGGER trg_immutable_jobs
BEFORE UPDATE OF min_salary, max_salary ON jobs
FOR EACH ROW
BEGIN
    :NEW.min_salary := :OLD.min_salary;
    :NEW.max_salary := :OLD.max_salary;
END;

##ZADANIE 6

INSERT INTO departments (department_id, department_name, manager_id, location_id)
VALUES (999, 'Test Dept', 100, 1700);

DELETE FROM departments WHERE department_id = 999;

SELECT * FROM archiwum_departamentow;

##

UPDATE employees SET salary = 30000 WHERE employee_id = 100;

SELECT * FROM zlodziej;

##

INSERT INTO employees (last_name, email, hire_date, job_id, salary) 
VALUES ('Kowalski', 'kowalski@test.com', SYSDATE, 'IT_PROG', 6500);

SELECT * FROM employees WHERE email = 'kowalski@test.com';

##

DELETE FROM job_grades; Operacje na tabeli JOB_GRADES są zabronione.

##

SELECT * FROM jobs WHERE job_id = 'IT_PROG';

UPDATE jobs SET min_salary = 10, max_salary = 999999 WHERE job_id = 'IT_PROG';

SELECT * FROM jobs WHERE job_id = 'IT_PROG';
